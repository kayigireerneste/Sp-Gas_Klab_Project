'use strict'

const gulp = require('gulp')
const rename = require('gulp-rename')
const browserify = require('browserify')
const watchify = require('watchify')
const bundleLogger = require('../util/bundleLogger')
const handleErrors = require('../util/handleErrors')
const source = require('vinyl-source-stream')

gulp.task('browserify', function () {
  const dest = './example'

  let bundler = browserify({
    cache: {},
    packageCache: {},
    fullPaths: true,
    entries: ['./example/_app.js'],
    debug: true
  })
  .transform('babelify', { presets: ['react'] })

  const bundle = function () {
    bundleLogger.start()

    return bundler
      .bundle()
      .on('error', handleErrors)
      .pipe(source('example/_app.js'))
      .pipe(rename('app.js'))
      .pipe(gulp.dest(dest))
      .on('end', bundleLogger.end)
  }

  bundler = watchify(bundler)
  bundler
    .on('update', bundle)
    .on('error', handleErrors)

  return bundle()
})
